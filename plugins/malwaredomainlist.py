import datetime
import feedparser
import re

from yapsy.IPlugin import IPlugin


class PluginOne(IPlugin):
    NAME = "malwaredomainlist"
    DIRECTION = "outbound"
    URLS = ['http://www.malwaredomainlist.com/hostslist/mdl.xml']

    def get_URLs(self):
        return self.URLS

    def get_direction(self):
        return self.DIRECTION

    def get_name(self):
        return self.NAME

    def process_data(self, source, response):
        current_date = str(datetime.date.today())
        data = []
        feed = feedparser.parse(response)

        for entry in feed.entries:
            desc = entry.description
            url = desc.split(' ')[1].rstrip(',')
            if url == '':
                continue
            if url == '-':
                url = desc.split(' ')[4].rstrip(',')
            url = re.sub('&amp;', '&', url)
            if not re.match('http', url):
                url = 'http://' + url
            data.append({'indicator': url, 'indicator_type': "URL", 'indicator_direction': self.DIRECTION,
                         'source_name': self.NAME, 'source': source, 'note': desc, 'date': current_date})
        return data
